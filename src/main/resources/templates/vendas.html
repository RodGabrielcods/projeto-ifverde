<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vendas - IFVerde</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <style>
        .alert-error {
            background-color: #450a0a;
            color: #fca5a5;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid #b91c1c;
            margin-bottom: 1.5rem;
            font-weight: bold;
            text-align: center;
        }
    </style>
</head>

<body>
    <header>
        <div class="container">
            <a href="/"><img src="/img/logo.png" alt="Logo IFVERDE"></a>
            <nav>
                <ul>
                    <li><a href="/">Início</a></li>
                    <li><a href="/estoque">Estoque</a></li>
                    <li><a href="/vendas">Vendas</a></li>
                    <li><a href="/despesas">Despesas</a></li>
                    <li><a href="/calendario">Calendário</a></li>
                    <li><a href="/historico">Relatórios</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="container">

        <div th:if="${mensagemErro}" class="alert-error">
            ⚠️ <span th:text="${mensagemErro}">Erro</span>
        </div>

        <section class="card-section">
            <h1>Registrar Nova Venda</h1>
            <p>Selecione o produto e a quantidade. O valor será calculado automaticamente.</p>

            <form th:action="@{/venda/salvar}" th:object="${novaVenda}" method="post">
                <div class="form-row">
                    <div class="form-group" style="flex: 2;">
                        <label for="produtoSelect">Produto:</label>
                        <select id="produtoSelect" th:field="*{produto}" required onchange="calcularTotal()">
                            <option value="" data-preco="0" selected>Selecione...</option>

                            <option th:each="prod : ${produtosDisponiveis}" th:value="${prod.id}"
                                th:data-preco="${prod.precoUnitario != null ? prod.precoUnitario : 0}"
                                th:text="${prod.nome} + ' (R$ ' + ${#numbers.formatDecimal(prod.precoUnitario != null ? prod.precoUnitario : 0, 1, 2)} + ' cada ' + ${prod.unidade} + ' - Em estoque: ' + ${prod.quantidade} + ')'">
                            </option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="quantidadeInput">Quantidade Vendida:</label>
                        <input type="number" step="0.1" id="quantidadeInput" th:field="*{quantidadeVendida}"
                            placeholder="0.0" required oninput="calcularTotal()">
                    </div>

                    <div class="form-group">
                        <label for="valorInput">Valor Total (R$):</label>
                        <input type="number" step="0.01" id="valorInput" th:field="*{valor}" placeholder="Automático..."
                            required readonly
                            style="background-color: #1e293b; cursor: not-allowed; border-color: #4ade80;">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="data">Data da Venda:</label>
                        <input type="date" id="data" th:field="*{data}" required>
                    </div>
                    <div class="form-group" style="flex: 2;">
                        <label for="descricao">Observação (Opcional):</label>
                        <input type="text" id="descricao" th:field="*{descricao}"
                            placeholder="Ex: Cliente Restaurante...">
                    </div>
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">Confirmar
                    Venda</button>
            </form>
        </section>

        <section class="card-section">
            <h2>Histórico de Vendas</h2>
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Produto</th>
                            <th>Qtd.</th>
                            <th>Valor Total</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="venda : ${listaVendas}">
                            <td th:text="${#temporals.format(venda.data, 'dd/MM/yyyy')}"></td>
                            <td>
                                <strong th:if="${venda.produto != null}" th:text="${venda.produto.nome}"
                                    style="color: #cbd5e1;"></strong>
                            </td>
                            <td>
                                <span th:text="${venda.quantidadeVendida}"></span>
                                <span th:if="${venda.produto != null}" th:text="${venda.produto.unidade}"></span>
                            </td>
                            <td style="color: #4ade80; font-weight: bold;"
                                th:text="'R$ ' + ${#numbers.formatDecimal(venda.valor, 1, 2)}"></td>
                            <td class="text-right">
                                <a th:href="@{/venda/excluir/{id}(id=${venda.id})}" style="color: #ef4444;"
                                    onclick="return confirm('Excluir venda?')">✕</a>
                            </td>
                        </tr>
                        <tr th:if="${#lists.isEmpty(listaVendas)}">
                            <td colspan="5" class="text-center">Nenhuma venda registrada.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
    </main>
    <footer>
        <p>&copy; 2025 IFVerde</p>
    </footer>

    <script>
        function calcularTotal() {
            // 1. Pega o elemento SELECT e o INPUT de Quantidade
            var select = document.getElementById('produtoSelect');
            var qtdInput = document.getElementById('quantidadeInput');
            var valorInput = document.getElementById('valorInput');

            // 2. Pega o preço que escondemos no atributo "data-preco" da opção selecionada
            var precoUnitario = select.options[select.selectedIndex].getAttribute('data-preco');
            var quantidade = qtdInput.value;

            // 3. Faz a conta (se tiver números válidos)
            if (precoUnitario && quantidade) {
                var total = parseFloat(precoUnitario) * parseFloat(quantidade);
                // Arredonda para 2 casas decimais
                valorInput.value = total.toFixed(2);
            } else {
                valorInput.value = '';
            }
        }

        // Define a data de hoje automaticamente no campo data
        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('data').valueAsDate = new Date();
        });
    </script>
</body>

</html>